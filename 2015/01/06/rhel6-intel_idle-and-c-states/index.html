<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>RHEL6 - intel_idle과 C States &middot; Lunatine</title>
        <meta name="description" content="C/G/S/P states intel_idle과 관련된 내용을 다루기에 앞서 P-States와 C-States에 대해서 간단히 정리하고자 한다. Intel 아키텍처 환경에서 리눅스 커널과 CPU를 알아가다보면 P/S/G/C States에 대한 내용을 접할 수 있다. 이러한 상태 값에 대해서 간단히 설명하도록 하겠다.
P-States P-States는 작업 부하에 따라서 CPU의 전압과 클럭주파수를 조절하는 정도를 정의 한 값으로 명령어 처리(Operation)상태를 기준으로 절전 및 성능 향상을 꾀하기 위한 기법이다. 과거에는 SpeedStep이라는 기술로 소개 되었기(정확히 같은 것은 아니다) 때문에 단순히 클럭주파수를 조절해서 에너지 절약을 위한 방안으로만 치부되었는데 CPU가 연산처리를 할 때의 상태를 반영하고 있다.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.55.6" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="RHEL6 - intel_idle과 C States">
<meta property="og:description" content="C/G/S/P states intel_idle과 관련된 내용을 다루기에 앞서 P-States와 C-States에 대해서 간단히 정리하고자 한다. Intel 아키텍처 환경에서 리눅스 커널과 CPU를 알아가다보면 P/S/G/C States에 대한 내용을 접할 수 있다. 이러한 상태 값에 대해서 간단히 설명하도록 하겠다.
P-States P-States는 작업 부하에 따라서 CPU의 전압과 클럭주파수를 조절하는 정도를 정의 한 값으로 명령어 처리(Operation)상태를 기준으로 절전 및 성능 향상을 꾀하기 위한 기법이다. 과거에는 SpeedStep이라는 기술로 소개 되었기(정확히 같은 것은 아니다) 때문에 단순히 클럭주파수를 조절해서 에너지 절약을 위한 방안으로만 치부되었는데 CPU가 연산처리를 할 때의 상태를 반영하고 있다.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://lunatine.github.io/2015/01/06/rhel6-intel_idle-and-c-states/">
        <link rel="stylesheet" href="https://lunatine.github.io/dist/styles.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
    </head>
    <body>
        

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Lunatine&#39;s Box" href="https://lunatine.github.io/">Lunatine&#39;s Box</a>
                            </h1>
                        
                        <a class="button-square" href="https://lunatine.github.io/index.xml"><i class="fa fa-rss"></i></a>
                        
                        
                        
                        
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="/posts">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="Tags" href="/tags/">Tags</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/about/">About</a>
    </li>

    <li class="site-nav-item">
        <a title="Notice" href="/notice/">Notice</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">RHEL6 - intel_idle과 C States</h1>
    
    <p class="post-date">
        <span>Published <time datetime="2015-01-06" itemprop="datePublished">Tue, Jan 6, 2015</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="http://lunatine.net" itemprop="url" rel="author">Lunatine</a>
            </span>
        </span>
    </p>
    
        <p class="post-reading post-line">
            <span>Estimated reading time: 5 min</span>
        </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    

<h1 id="c-g-s-p-states">C/G/S/P states</h1>

<p>intel_idle과 관련된 내용을 다루기에 앞서 P-States와 C-States에 대해서 간단히 정리하고자 한다. Intel 아키텍처 환경에서 리눅스 커널과 CPU를 알아가다보면 P/S/G/C States에 대한 내용을 접할 수 있다. 이러한 상태 값에 대해서 간단히 설명하도록 하겠다.</p>

<h2 id="p-states">P-States</h2>

<p>P-States는 작업 부하에 따라서 CPU의 전압과 클럭주파수를 조절하는 정도를 정의 한 값으로 명령어 처리(Operation)상태를 기준으로 절전 및 성능 향상을 꾀하기 위한 기법이다. 과거에는 SpeedStep이라는 기술로 소개 되었기(정확히 같은 것은 아니다) 때문에 단순히 클럭주파수를 조절해서 에너지 절약을 위한 방안으로만 치부되었는데 CPU가 연산처리를 할 때의 상태를 반영하고 있다.</p>

<p>예를 들어 최근 사용되는 Intel CPU의 Turbo Boost 상태는 P-State 0(P0)를 의미한다.</p>

<h2 id="c-states">C-States</h2>

<p>C-States는 CPU 내부의 특정 부분이 활성화 되거나 낮은 성능 상태로 실행될지를 반영하는 값으로 CPU에서 사용중이 아닌 부분들을 비활성화하여 전원의 효율화를 높이기 위한 상태 값이다. P-State와 다르게 C-State는 유휴(Idle)상태를 기준으로하여 평가한다. 따라서, C0는 활성화 된 일반적인 상태를 의미하며 C0 상태에서 P0~Pn 상태로 나누어서 볼 수 있다. 네할렘부터는 C6 상태가 추가되었는데 C6는 각종 작업들을 저장하고 이미 작동을 멈춘 CPU코어에 공급되는 전원을 차단하는 상태이다. 그리고, 샌디브리지에서 C7이 추가되었고 이는 C6에서 추가로 L3캐시까지 비워버린(Flush) 상태를 의미한다. (p.s 절전도 좋지만 머리 아프다 인텔 놈들아..)</p>

<h2 id="g-states">G-States</h2>

<p>Global States를 의미하며 간단히 말해 사용자가 인지할 수 있는 상태를 반영한다. G0는 동작상태 (전원 On) G1은 잠자기모드 상태 G3는 전원 Off 상태이다.</p>

<h2 id="s-states">S-States</h2>

<p>Sleep States를 의미하며 G1에서 세부적인 잠자기모드 상태를 나타낸다.</p>

<h2 id="processor-power-states">Processor Power States</h2>

<p>앞에서 언급한 상태들을 알아보기 쉽게 도식화 하면 아래와 같다.</p>

<p><img src="/images/2015/01/powerstate.jpg" alt="powerstate.jpg" />
이미지 출처: <a href="http://wccftech.com/review/intel-core-i7-4790k-haswell-refresh-devils-canyon-processor-review/">Intel Core i7-4790K Haswell Refresh “Devil’s Canyon” Processor Review</a></p>

<h1 id="intel-idle">intel_idle</h1>

<p>모듈 이름처럼 Idle 상태를 관리하기 위한 것으로 C-States와 관련이 있는 모듈이다. intel_idle이 사용되기 이전에는 C-States를 OS에서 관리하기 위해서 acpi_idle이란 모듈이 사용되었다. 그리고, 그 당시에 intel_idle은 EXPERIMENTAL로 커널에 포함되어 있었는데 2.6.35 버전부터로 알고 있었기 때문에 2.6.32 기반의 RHEL6에서 별로 신경쓰고 있지 않았다. (RHEL7만 신경쓰였을 뿐이지&hellip;) 그런데, <strong>스마트한 직장동료</strong>가 RHEL6에서도 intel_idle 때문에 C-States 영향을 받고 있다고 제보하였고 이를 해결하기 위한 설정방법 등을 공유하였다. 그래서 찾아보니 RHEL6.2 기술문서부터 intel_idle.max_cstate 파라미터에 대한 내용이 언급 되어있었다.</p>

<p><img src="/images/2015/01/oops.png" alt="oops.png" /></p>

<h2 id="왜-문제가-되는-것인가">왜 문제가 되는 것인가?</h2>

<p>기존 acpi_idle 모듈의 경우 C-State latency와 관련하여 정확도도 높지 않았고 기본적으로 BIOS 설정에 따라서 주어진 환경 내에서만 상태를 변경하는 정도가 고작이었으나 intel_idle의 경우 BIOS 설정에 직접적으로 개입하여 C-State를 조절하는 모듈이기 때문에 문제가 되는 것이다.</p>

<p>일반적으로 서버시스템의 경우 빠른 응답속도를 목표로하기 때문에 소위 Performance 모드로 통칭되는 BIOS 설정상태를 유지하여 CPU가 잠들지 않도록 하는 편인데 C-State를 커널이 개입하여 제어해 버리면 쉬고 있던 상태에서 C0 상태로 만들기 위한 시간(Wake-up time)이 소모되어 성능 저하로 이어지게 된다. 즉, 절전보다는 빠른 반응이 필요한데 이를 intel_idle 모듈이 작업 상태에 따라서 조절해 버리는 것이다. 그것도 BIOS 설정과 무관하게&hellip;</p>

<h2 id="해결방법">해결방법</h2>

<p>친절하게도 Red Hat Enterprise Linux Technical Note에 아래와 같이 소개하고 있다.</p>

<pre><code>intel_idle.max_cstate

A new kernel parameter, intel_idle.max_cstate, has been added to specify the maximum depth of a C-state, or to disable intel_idle and fall back to acpi_idle. For more information, refer to the /usr/share/doc/kernel-doc-&lt;version&gt;/Documentation/kernel-parameters.txt file.
</code></pre>

<p>즉, 커널 부팅 파라미터에 <code>intel_idle.max_cstate=0</code> 값을 설정하면 acpi_idle을 이용하도록 부팅하게 된다는 것이다.</p>

<h2 id="온라인-해결방법">온라인 해결방법</h2>

<p>직장동료 Alden이 커널파라미터의 경우 리부팅의 부담이 있기 때문에 기존에 운영하는 장비도 적용 할 수 있도록 tuned의 프로파일을 이용한 설정 방법을 제안하였다.</p>

<pre><code>$ tuned-adm profile latency-performance
</code></pre>

<p>tuned의 프로파일 중에서 latency-performance라는 프로파일이 있으며 이를 적용하면 아래 그림과 같이 기존에 C7 상태까지 떨어지던 idle 상태가 C1이하로 내려가지 않는 모습을 볼 수 있다.</p>

<ul>
<li><p>latency-performance 적용 전
<img src="/images/2015/01/cstate-c7-1.png" alt="cstate-c7.png" /></p></li>

<li><p>latency-performance 적용 후
<img src="/images/2015/01/cstate-c1.png" alt="cstate-c1.png" /></p></li>
</ul>

<h3 id="예외사항-1">예외사항 (1)</h3>

<p>실제 장비들을 샘플링하여 테스트 해 본 결과 tuned-adm을 설정하더라도 E3/E5 계열(샌디브리지)의 CPU는 바로 적용이 되었으나 C6까지있는 네할렘 CPU들은 여전히 말을 듣지 않았다.</p>

<p><img src="/images/2015/01/cstate-c6.png" alt="cstate-c6.png" /></p>

<p>그래서, /dev/cpu_dma_latency 장치(4바이트 값을 갖는 장치이다)에 직접 latency 값을 100으로 설정해 보았다.</p>

<pre><code>$ exec 3&gt; /dev/cpu_dma_latency
$ echo -ne '\0144\000\000\000' &gt;&amp;3
</code></pre>

<p><img src="/images/2015/01/cstate-c3.png" alt="cstate-c3.png" /></p>

<p>그랬더니 C3 상태이하로 내려가지 않았다. 조금더 욕심을 내서 8로 설정했더니 C1상태 이하로 내려가지 않는 것을 확인 할 수 있었다.</p>

<p><img src="/images/2015/01/cstate-c1-nehal.png" alt="cstate-c1-nehal.png" /></p>

<p>그래서 설정이 가능함에도 불구하고 왜 tuned에서 처리가 안되는지 확인해보니 cpu_dma_latency 값을 조절하는 <code>/usr/libexec/tuned/pmqos-static.py</code> 파일이 설치되지 않는 것을 확인 할 수 있었다.</p>

<p>결론은 tuned-0.2.19-13.el6 이상의 패키지를 사용해야만 cpu_dma_latency 장치를 조절하는 PMQOS스크립트 패치가 반영되어 Python 스크립트가 포함된다. 이 패키지는 RHEL6.5 이상 저장소에서 제공하고 있다.</p>

<p><strong>한줄요약: RHEL6.5에 있는 tuned-0.2.19-13.el6 버전 이상을 사용해라. RHEL6.3에도 아무 문제 없이 잘 설치된다.</strong></p>

<h3 id="예외사항-2">예외사항 (2)</h3>

<p>tuned가 제공하는 latency-performance 프로파일에는 IO스케줄러를 <strong>deadline</strong>으로 설정하도록 되어 있다. 만약, CPU C-State 값 때문에 적용하는 것이라면 그리고 IO스케줄러를 바꿀 생각이 없다면 <code>/etc/tune-profiles/latency-performance/ktune.sysconfig</code> 파일을 열어 ELEVATOR 항목을 원하는 스케줄러로 수정하고 적용하도록 하자.</p>

<pre><code># ktune service configuration

# This is the ktune sysctl file.  You can comment this out to prevent ktune
# from applying its sysctl settings.
#SYSCTL=&quot;/etc/sysctl.ktune&quot;

# Use *.conf files in the ktune configuration directory /etc/ktune.d.
#   Value: yes|no,  default: yes
# It is useful if you want to load settings from additional files. Set this to
# no if you to prevent ktune from using these additional files.
USE_KTUNE_D=&quot;yes&quot;

# This is the custom sysctl configuration file.  Any settings in this file will
# be applied after the ktune settings, overriding them.  Comment this out to
# use only the ktune settings.
SYSCTL_POST=&quot;/etc/sysctl.conf&quot;

# This is the I/O scheduler ktune will use.  This will *not* override anything
# explicitly set on the kernel command line, nor will it change the scheduler
# for any block device that is using a non-default scheduler when ktune starts.
# You should probably leave this on &quot;deadline&quot;, but &quot;as&quot;, &quot;cfq&quot;, and &quot;noop&quot; are
# also legal values.  Comment this out to prevent ktune from changing I/O
# scheduler settings.
ELEVATOR=&quot;deadline&quot;

# These are the devices, that should be tuned with the ELEVATOR
ELEVATOR_TUNE_DEVS=&quot;/sys/block/{sd,cciss,dm-,vd}*/queue/scheduler&quot;
</code></pre>

<h3 id="끝">끝</h3>

<p><strong>Thanks to</strong> Alden</p>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/rhel6/">RHEL6</a>, 
            
                <a href="/tags/centos7/">CentOS7</a>, 
            
                <a href="/tags/intel_idle/">intel_idle</a>, 
            
                <a href="/tags/c-states/">C-States</a>, 
            
                <a href="/tags/cpu/">CPU</a>, 
            
                <a href="/tags/performance/">Performance</a>, 
            
                <a href="/tags/tuned/">Tuned</a>, 
            
                <a href="/tags/rhel7/">RHEL7</a>, 
            
                <a href="/tags/centos6/">CentOS6</a>
            
        </p>
    

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=RHEL6%20-%20intel_idle%ea%b3%bc%20C%20States&url=https%3a%2f%2flunatine.github.io%2f2015%2f01%2f06%2frhel6-intel_idle-and-c-states%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flunatine.github.io%2f2015%2f01%2f06%2frhel6-intel_idle-and-c-states%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        

        
        
    </div>
</footer>

        
    <div class="comments">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lunatine" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Lunatine&#39;s Box" href="https://lunatine.github.io/">Lunatine&#39;s Box</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2019 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://lunatine.github.io/js/jquery-1.11.3.min.js"></script>
        <script src="https://lunatine.github.io/js/jquery.fitvids.js"></script>
        
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        
        <script src="https://lunatine.github.io/js/scripts.js"></script>
    </body>
</html>

